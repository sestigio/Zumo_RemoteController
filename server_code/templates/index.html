<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zumo Cockpit</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="dashboard">
        <div class="box gauge-box">
            <div class="gauge" id="speedGauge" style="--progress: 0deg;">
                <div class="gauge-text"><span id="speedVal">0</span>%</div>
            </div>
        </div>

        <div class="box status-box">
            <div class="radar-placeholder"></div>
            <div class="lights-container">
                <div class="light-group">
                    <div class="led" id="L1"></div>
                    <span>light 1</span>
                </div>
                <div class="light-group">
                    <div class="led" id="L2"></div>
                    <span>light 2</span>
                </div>
                <div class="light-group">
                    <div class="led" id="L3"></div>
                    <span>light 3</span>
                </div>
            </div>
        </div>

        <div class="box pedal-box">
            <button class="pedal btn-brake" onmousedown="send('BRAKE_ON')" onmouseup="send('BRAKE_OFF')">BRAKE</button>
            <button class="pedal btn-acc" onmousedown="send('ACC_ON')" onmouseup="send('ACC_OFF')">ACCEL</button>
        </div>

        <div class="box steer-box">
            <input type="range" id="steerWheel" min="-100" max="100" value="0" oninput="sendSteer(this.value)">
            <div class="label">Volante (Giro)</div>
        </div>

        <div class="box extra-box">
            </div>
    </div>

    <script>
        let lastTime_pedal = 0;
        let lastTime_steer = 0;
        const throttleMS = 100; // Solo enviamos datos cada 100ms

        function send(cmd) {
            const now = Date.now();
    
            // Si ha pasado menos tiempo que throttleMS, no hacemos nada
            if (now - lastTime_pedal < throttleMS) return;

            lastTime_pedal = now;

            fetch('/pedals', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ cmd: cmd })
            });
        }

        function sendSteer(val) {
            const now = Date.now();
    
            // Si ha pasado menos tiempo que throttleMS, no hacemos nada
            if (now - lastTime_steer < throttleMS) return;

            lastTime_steer = now;

            fetch('/steer', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ s: parseInt(val) })
            });
        }

        function updateDashboard() {
            fetch('/get_telemetry')
            .then(response => response.json())
            .then(data => {
                const vReal = data.velocidad_real;
                
                // 1. Actualizar el texto del porcentaje
                document.getElementById('speedVal').innerText = vReal;
                
                // 2. Actualizar la barra circular (conic-gradient)
                // Multiplicamos por 3.6 porque 100% = 360 grados
                const degrees = vReal * 3.6;
                document.getElementById('speedGauge').style.setProperty('--progress', `${degrees}deg`);
            })
        .catch(err => console.error("Error obteniendo telemetr√≠a:", err));
        }

        // Lo ejecutamos cada 100ms
        setInterval(updateDashboard, 100);
    </script>
</body>
</html>